<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat Room</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body {
            background: linear-gradient(to bottom right, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }

        #messagesContainer {
            height: 450px;
            overflow-y: auto;
        }

        #onlineUsersList {
            max-height: 450px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
<div class="container py-4">
    <div class="row">

        <!-- Main Chat Area (Left Side) -->
        <div class="col-lg-8 mb-3">

            <!-- Header -->
            <div class="card border-0 shadow-lg rounded-4 mb-3">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1">
                                <i class="bi bi-chat-dots-fill text-primary me-2"></i>
                                Chat Room
                            </h4>
                            <p class="text-body-secondary small mb-0" id="status">
                                <span class="badge bg-danger">disconnected</span>
                            </p>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="badge bg-primary rounded-pill px-3 py-2">
                                <i class="bi bi-person-fill me-1"></i>
                                <span id="displayUsername">Guest</span>
                            </span>
                            <button class="btn btn-outline-danger rounded-pill" id="leaveBtn">
                                <i class="bi bi-box-arrow-right me-1"></i>
                                Leave
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Input (TOP) -->
            <div class="card border-0 shadow-lg rounded-4 mb-3">
                <div class="card-body p-4">
                    <label class="form-label fw-bold mb-3">
                        <i class="bi bi-pencil-square me-1"></i>
                        Send Message
                    </label>
                    <div class="input-group input-group-lg">
                        <input
                                type="text"
                                class="form-control rounded-pill border-2"
                                id="messageInput"
                                placeholder="Type your message..."
                                disabled
                        >
                        <button class="btn btn-primary rounded-pill ms-2 px-4" id="sendBtn" disabled>
                            <i class="bi bi-send-fill me-2"></i>
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="card border-0 shadow-lg rounded-4">
                <div class="card-header bg-body-tertiary border-0 rounded-top-4 py-3">
                    <h6 class="mb-0 fw-semibold">
                        <i class="bi bi-chat-text me-2"></i>
                        Messages
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div id="messagesContainer">
                        <!-- Welcome message -->
                        <div class="text-center text-body-secondary py-5">
                            <i class="bi bi-chat-square-text display-4 mb-3"></i>
                            <p class="mb-0">Welcome to the chat room!</p>
                            <small>Messages will appear here...</small>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Online Users Sidebar (Right Side) -->
        <div class="col-lg-4 mb-3">

            <div class="card border-0 shadow-lg rounded-4 sticky-top" style="top: 20px;">
                <div class="card-header bg-body-tertiary border-0 rounded-top-4 py-3">
                    <h6 class="mb-0 fw-semibold">
                        <i class="bi bi-people-fill me-2"></i>
                        Online Users
                        <span class="badge bg-primary rounded-pill ms-2" id="onlineCount">0</span>
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div id="onlineUsersList">
                        <!-- User list will be populated here -->
                        <div class="text-center text-body-secondary py-4">
                            <i class="bi bi-person-x fs-1 mb-2"></i>
                            <p class="small mb-0">No users online</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const ChatApp = {
        config: {
            username: localStorage.getItem('chatUsername'),
            websocketUrl: 'ws://localhost:8080/room'
        },
        ui: {
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            messagesContainer: document.getElementById('messagesContainer'),
            onlineUsersList: document.getElementById('onlineUsersList'),
            onlineCount: document.getElementById('onlineCount'),
            leaveBtn: document.getElementById('leaveBtn'),
            status: document.getElementById('status'),
            displayUsername: document.getElementById('displayUsername')
        },
        socket: null,

        init() {
            this.checkUsername();
            this.loadChatHistory();
            this.connectWebSocket();
            this.setupEventListeners();
        },

        checkUsername() {
            if (!this.config.username) {
                window.location.href = 'index.html';
            } else {
                this.ui.displayUsername.textContent = this.config.username;
            }
        },

        setupEventListeners() {
            this.ui.sendBtn.addEventListener('click', () => this.sendMessage());
            this.ui.messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    this.sendMessage();
                }
            });
            this.ui.leaveBtn.addEventListener('click', () => this.leaveChat());
        },

        connectWebSocket() {
            this.socket = new WebSocket(`${this.config.websocketUrl}?username=${this.config.username}`);
            this.socket.onopen = () => this.handleSocketOpen();
            this.socket.onclose = () => this.handleSocketClose();
            this.socket.onerror = (error) => this.handleSocketError(error);
            this.socket.onmessage = (event) => this.handleSocketMessage(event);
        },

        handleSocketOpen() {
            console.log("Successfully connected to server");
            this.ui.status.innerHTML = `<span class="badge bg-success">Connected</span>`;
            this.ui.messageInput.disabled = false;
            this.ui.sendBtn.disabled = false;
        },

        handleSocketClose() {
            console.log("Connection closed.");
            this.ui.status.innerHTML = `<span class="badge bg-danger">Disconnected</span>`;
            this.ui.messageInput.disabled = true;
            this.ui.sendBtn.disabled = true;
        },

        handleSocketError(error) {
            console.log("There is an error: ", error);
            this.ui.status.innerHTML = `<span class="badge bg-danger">Disconnected</span>`;
        },

        handleSocketMessage(event) {
            console.log("Raw data from server:", event.data);
            const data = JSON.parse(event.data);

            switch (data.message_type) {
                case "users_list":
                    this.updateOnlineUsers(data.connected_users);
                    break;
                case "chat":
                    this.displayNewMessage(data);
                    this.saveMessageToHistory(data);
                    break;
            }
        },

        sendMessage() {
            const message = this.ui.messageInput.value.trim();
            if (message && this.socket && this.socket.readyState === WebSocket.OPEN) {
                this.socket.send(message);
                this.ui.messageInput.value = '';
            }
        },

        displayNewMessage(data) {
            const welcomeMessage = this.ui.messagesContainer.querySelector('.text-center.text-body-secondary.py-5');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            const isCurrentUser = data.username === this.config.username;
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('d-flex', 'mb-3', isCurrentUser ? 'justify-content-end' : 'justify-content-start');

            messageDiv.innerHTML = `
                <div class="d-flex flex-column ${isCurrentUser ? 'align-items-end' : 'align-items-start'}">
                    <small class="text-body-secondary mb-1">${isCurrentUser ? 'You' : data.username}</small>
                    <div class="card ${isCurrentUser ? 'bg-primary text-white' : 'bg-body-secondary'} border-0 rounded-4">
                        <div class="card-body p-3">
                            <p class="mb-0">${data.message}</p>
                        </div>
                    </div>
                </div>
            `;

            this.ui.messagesContainer.appendChild(messageDiv);
            this.ui.messagesContainer.scrollTop = this.ui.messagesContainer.scrollHeight;
        },

        updateOnlineUsers(users) {
            this.ui.onlineCount.textContent = users.length;
            if (users.length === 0) {
                this.ui.onlineUsersList.innerHTML = `
                    <div class="text-center text-body-secondary py-4">
                        <i class="bi bi-person-x fs-1 mb-2"></i>
                        <p class="small mb-0">No users online</p>
                    </div>
                `;
                return;
            }

            this.ui.onlineUsersList.innerHTML = users.map(user => `
                <div class="d-flex align-items-center p-2 mb-2 bg-body-secondary rounded">
                    <div class="rounded-circle bg-success d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                        <i class="bi bi-person-fill text-white"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-0 fw-semibold small">${user}</p>
                        <p class="mb-0 text-success" style="font-size: 0.7rem;">
                            <i class="bi bi-circle-fill" style="font-size: 0.4rem;"></i>
                            Online
                        </p>
                    </div>
                </div>
            `).join('');
        },

        saveMessageToHistory(data) {
            let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
            chatHistory.push(data);
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        },

        loadChatHistory() {
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
            for (const message of chatHistory) {
                this.displayNewMessage(message);
            }
        },

        leaveChat() {
            if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                console.log('Closing socket connection...');
                this.socket.close();
            }
            localStorage.removeItem('chatUsername');
            localStorage.removeItem('chatHistory');
            window.location.href = 'index.html';
        }
    };

    document.addEventListener('DOMContentLoaded', () => ChatApp.init());

</script>
</body>
</html>
